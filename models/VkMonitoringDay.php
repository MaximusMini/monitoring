<?php

namespace app\models;

use Yii;
use yii\base\Model;

use GuzzleHttp\Client; // –ø–æ–¥–∫–ª—é—á–∞–µ–º Guzzle

class VkMonitoringDay extends Model{
   
    public $id_connect_DB;              // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ë–î
    public $arr_id_group=[];            // –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è id –≥—Ä—É–ø–ø
    public $arr_type_group=[];          // –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä—É–ø–ø
    
    public $arr_posts=[];               // –º–∞—Å—Å–∏–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ—Å—Ç–∞—Ö
    public $arr_attach=[];              // –º–∞—Å—Å–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–± attachnments
    public $answer;    
    
    
     // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞
    public function __construct(){
        // —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        $this->id_connect_DB = Yii::$app->db;    
    }
    
    // —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ curl
	function curl_get ($url, $referer = 'http://google.com'){
		$ch = curl_init();// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º curl
		// –∑–∞–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ–ø—Ü–∏–∏) curl 
		curl_setopt($ch, CURLOPT_URL,$url);
		curl_setopt($ch, CURLOPT_HEADER,0);
		curl_setopt($ch, CURLOPT_USERAGENT,'Mozilla/5.0 (Windows NT 6.1; rv:42.0) Gecko/20100101 Firefox/42.0');
		curl_setopt($ch, CURLOPT_REFERER,$referer);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER,true); // —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã curl –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –∞ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—å—Å—è
		//  –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å curl
		$data = curl_exec($ch);
		curl_close($ch);
		return $data;
	}
    
    // –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    function main(){
        $this->get_id_group();                     // –ø–æ–ª—É—á–µ–Ω–∏–µ id –≥—Ä—É–ø–ø –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        $this->get_group_type();                    // –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –≥—Ä—É–ø–ø
        $this->get_posts_day();
    }
    
    // —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è id –≥—Ä—É–ø–ø –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    function get_id_group(){
        //–∑–∞–ø—Ä–æ—Å
        $query = 'SELECT group_id FROM vk_groups';
        $this->arr_id_group=$this->id_connect_DB->createCommand($query)->queryAll();
        return $this->arr_id_group;
    }
    
    // —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä—É–ø–ø—ã
    function get_group_type(){
        for($i=0; $i<count($this->arr_id_group); $i++){
            // –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä—É–ø–ø—ã
            $type_group = json_decode(file_get_contents('https://api.vk.com/method/groups.getById?group_id='.$this->arr_id_group[$i]['group_id'].'&fields=type&v=5.92&access_token=33be01cf14cf4e807b075601e45972657fd2c7fd532da9e20a1b641f85b6c4a4bb22ff38b71167321b02b'),true)['response'][0]['type'];
            $this->arr_type_group[$this->arr_id_group[$i]['group_id']] = $type_group; 
        }
        return;
    } 
    
    // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
    function get_posts_day(){
        // –æ—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã vk_posts
        //$query_TRUNCATE="TRUNCATE TABLE vk_posts";
        $this->id_connect_DB->createCommand($query_TRUNCATE)->execute();
        for($i=0; $i<count($this->arr_id_group); $i++){
            // –∑–∞–ø—Ä–æ—Å 
            $this->answer = $this->curl_get("https://api.vk.com/method/wall.get?owner_id=-{$this->arr_id_group[$i]['group_id']}&count=3&offset=0&filter=owner&extended=1&v=5.69&access_token=33be01cf14cf4e807b075601e45972657fd2c7fd532da9e20a1b641f85b6c4a4bb22ff38b71167321b02b");
            // –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –º–∞—Å—Å–∏–≤
            $answer_arr = json_decode($this->answer,true);
            // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ'üí™üèªüí™üèª'
            if(isset($answer_arr['error'])){
                // –∑–∞–ø–∏—Å—å –ª–æ–≥–∞ –æ–± –æ—à–∏–±–∫–µ
                file_put_contents('logs/error_wall.get.log',
                                 'error method:wall.get '.date('d.m.Y G:i:s').
                                 ' id_group='.$this->arr_id_group[$i]['group_id'].
                                 ' error_code='.$answer_arr['error']['error_code'].
                                 ' error_msg='.$answer_arr['error']['error_msg']."\n"
                                 ,FILE_APPEND
                                 );
                // –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é
                $i=$i-1;continue;
                
            }
            // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –º–∞—Å—Å–∏–≤
            array_push($this->arr_posts, $answer_arr);
            // –æ–±—Ö–æ–¥ –∑–∞–ø–∏—Å–µ–π
            for($j=0; $j<count($answer_arr['response']['items']); $j++){
                // –∑–∞–ø–∏—Å—å –ª–æ–≥–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
                file_put_contents('logs/success_wall.get.log',
                                  'success method:wall.get '.date('d.m.Y G:i:s').' -|- '.
                                  'id_group='.$this->arr_id_group[$i]['group_id'].
                                  ' id_post='.$answer_arr['response']['items'][$j]['id']."\n",
                                  FILE_APPEND
                                  );
                // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø–æ—Å—Ç–µ –≤ –ë–î - –µ—Å–ª–∏ –Ω–µ—Ç—É => –∑–∞–ø–∏—Å–∞—Ç—å
                file_put_contents('logs/success_wall.get.log',
                                  'SELECT * FROM vk_posts WHERE id_group_post=\''.$this->arr_id_group[$i]['group_id'].'_'.$answer_arr['response']['items'][$j]['id'].'\''."\n",
                                  FILE_APPEND
                                  );
                if($this->id_connect_DB->createCommand('SELECT * FROM vk_posts WHERE id_group_post=\''.$this->arr_id_group[$i]['group_id'].'_'.$answer_arr['response']['items'][$j]['id'].'\'')->queryAll() == null){
                    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–∞ –Ω–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ—Å—Ç—å
                    if($answer_arr['response']['items'][$j]['is_pinned'] == null){
                        $is_pinned = 0;}else{$is_pinned = 1;}
                    // —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å—Ç–µ
                    $query_INSERT="INSERT INTO vk_posts(id_group_post, id_post, id_group, is_pinned, count, date_unix, date_post, time_post, text_post) VALUES (
                            '{$this->arr_id_group[$i]['group_id']}_{$answer_arr['response']['items'][$j]['id']}',
                            {$answer_arr['response']['items'][$j]['id']},
                            {$this->arr_id_group[$i]['group_id']},
                            {$is_pinned},
                            {$answer_arr['response']['count']},
                            {$answer_arr['response']['items'][$j]['date']},
                            '".date('d.m.Y',$answer_arr['response']['items'][$j]['date'])."',
                            '".date('G:i',$answer_arr['response']['items'][$j]['date'])."',
                            '".str_replace("'","\'",$answer_arr['response']['items'][$j]['text'])."')";
                    // —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–∏–¥ –∑–∞–ø—Ä–æ—Å–∞
                    // file_put_contents('query_INSERT.txt',$query_INSERT."\n",FILE_APPEND);
                    // –∑–∞–ø–∏—Å—å –≤ –ë–î –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å—Ç–µ
                    $this->id_connect_DB->createCommand($query_INSERT)->execute();
                    
                    
                    
                    
                    // –ø—Ä–æ–≤–µ—Ä–∫–∞ attachments –∫ –ø–æ—Å—Ç—É
                    if($answer_arr['response']['items'][$j]['attachments'] != null){
                        
                        $this->arr_attach["{$this->arr_id_group[$i]['group_id']}_{$answer_arr['response']['items'][$j]['id']}"] = $answer_arr['response']['items'][$j]['attachments'];
                        
                        /*
                        file_put_contents('attach.txt',
                                  serialize($answer_arr['response']['items'][$j]['attachments'])."\n------------------------------------\n",
                                  //$answer_arr['response']['items'][$j]['date'],  
                                  FILE_APPEND
                                  );
                        */
                        
                        
                        // —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± attachments –∫ –ø–æ—Å—Ç—É

                        // –∑–∞–ø–∏—Å—å –≤ –ë–î –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± attachments –∫ –ø–æ—Å—Ç—É
                        //$this->id_connect_DB->createCommand($query_INSERT)->execute(); 
                    }
                }    
            }
            
                

            
           
            
            /*
            type                            $answer_arr['response']['attachments']['type']
            
            

            
            */
            
            
        }// for($i=0; $i<count($this->arr_id_group)
        return $this->arr_posts;
    }
    
    //–∑–∞–ø–∏—Å—å –ø–æ—Å—Ç–æ–≤ –≤ –ë–î
    function insert_posts_DB(){
        
    }
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
}